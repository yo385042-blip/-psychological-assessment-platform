# ZPAY_KEY 配置检查和修复指南

## 🔴 当前问题

错误信息显示签名字符串末尾是 `商户KEY`，这说明：

**`ZPAY_KEY` 环境变量的值是占位符文本 `商户KEY`，而不是真实的商户密钥！**

## ✅ 解决步骤

### 第一步：登录易支付后台获取真实密钥

1. 访问易支付官网：https://zpayz.cn
2. 使用您的商户账号登录
3. 进入 **商户中心** 或 **API接口设置**
4. 找到 **商户密钥（KEY）** 或 **通信密钥**
5. **复制完整的密钥值**（通常是32-64位的字符串，可能包含字母和数字）

### 第二步：在 Cloudflare Dashboard 中更新环境变量

1. **登录 Cloudflare Dashboard**
   - 访问：https://dash.cloudflare.com/
   - 使用您的账号登录

2. **进入您的 Worker 项目**
   - 左侧菜单 → **Workers 和 Pages**
   - 点击项目：`psychological-assessment-platform`

3. **进入环境变量设置**
   - 点击 **Settings（设置）** 标签
   - 找到 **Variables（变量和机密）** 部分
   - 点击 **Configure API tokens and other runtime variables** 或 **配置 API 令牌和其他运行时变量**

4. **检查 `ZPAY_KEY` 的值**
   - 找到 `ZPAY_KEY` 变量
   - **检查当前值**：
     - ❌ 如果是 `商户KEY` → **需要替换**
     - ❌ 如果是 `你的商户密钥` → **需要替换**
     - ❌ 如果是 `your-key-here` → **需要替换**
     - ❌ 如果是其他占位符文本 → **需要替换**

5. **更新为真实密钥**
   - 点击 `ZPAY_KEY` 变量进行编辑
   - **删除当前的值**（占位符）
   - **粘贴从易支付后台复制的真实密钥**
   - **注意**：
     - ✅ 不要有多余空格
     - ✅ 不要有换行
     - ✅ 完全复制，不要修改任何字符
     - ✅ 确保与易支付后台显示的值完全一致

6. **同时检查 `ZPAY_PID`**
   - 确认 `ZPAY_PID` 的值是您的真实商户ID（不是占位符）

7. **保存配置**
   - 点击 **Save（保存）** 按钮

### 第三步：重新部署 Worker

环境变量修改后，需要重新部署才能生效：

#### 方法1：推送代码自动部署（推荐）

```powershell
# 在项目目录运行
git add .
git commit -m "修复: 改进支付签名验证和KEY检查"
git push
```

推送后，Cloudflare 会自动部署。

#### 方法2：在 Dashboard 手动触发部署

1. 在 Cloudflare Dashboard → **部署（Deployments）** 标签
2. 找到最新的部署
3. 点击 **重新部署（Retry deployment）** 或 **Retry**

### 第四步：验证配置

部署完成后，测试支付功能：

1. **访问网站**：https://mindcube.top
2. **尝试支付**
3. **检查结果**：
   - ✅ 如果成功跳转到支付收银台 → 配置正确
   - ❌ 如果仍然报错 → 检查 Cloudflare Workers 日志

## 🔍 如何验证 KEY 是否正确

### 在 Cloudflare Workers 日志中查看

1. 登录 Cloudflare Dashboard
2. 进入项目 → **Logs（日志）**
3. 尝试支付，查看日志输出：
   - 如果看到：`支付配置错误: ZPAY_KEY 可能是占位符或无效值` → KEY 仍然是占位符
   - 如果看到：`支付配置检查: PID已配置, KEY已配置` → KEY 已配置，但可能值不正确

### 检查 KEY 特征

真实的商户密钥通常：
- ✅ 长度：32-64 位字符
- ✅ 格式：字母和数字的组合
- ✅ 不包含：中文、空格、特殊符号（除了可能的下划线或连字符）
- ❌ **不是**：`商户KEY`、`your-key`、`example-key` 等占位符

## 🐛 常见错误

### 错误1：KEY 仍然是占位符

**现象**：签名字符串末尾是 `商户KEY` 或类似的占位符文本

**原因**：环境变量 `ZPAY_KEY` 的值还是占位符

**解决**：
1. 按照上面的步骤更新 `ZPAY_KEY` 为真实密钥
2. 重新部署 Worker

### 错误2：KEY 值不正确

**现象**：签名仍然验证失败

**原因**：`ZPAY_KEY` 的值与易支付后台不一致

**解决**：
1. 重新从易支付后台复制密钥
2. 确保完全一致（注意大小写、空格等）
3. 更新环境变量并重新部署

### 错误3：环境变量未生效

**现象**：更新后仍然使用旧值

**原因**：未重新部署 Worker

**解决**：
1. 确认已保存环境变量
2. **必须重新部署 Worker**（环境变量修改不会立即生效）
3. 等待部署完成（通常 1-3 分钟）

## ✅ 检查清单

在测试支付前，请确认：

- [ ] 已从易支付后台获取真实的商户密钥
- [ ] 已在 Cloudflare Dashboard 中更新 `ZPAY_KEY`
- [ ] `ZPAY_KEY` 的值不是占位符（如 `商户KEY`、`你的商户密钥` 等）
- [ ] `ZPAY_PID` 的值是正确的商户ID
- [ ] 环境变量保存后已重新部署 Worker
- [ ] 密钥值与易支付后台完全一致
- [ ] 密钥中没有多余空格或特殊字符

## 📞 需要帮助？

如果按照以上步骤操作后仍然有问题：

1. **查看 Cloudflare Workers 日志**：检查是否有错误信息
2. **联系易支付客服**：确认商户账号状态和密钥是否正确
3. **提供错误信息**：将完整的错误信息截图或复制给我

---

**重要提示**：`ZPAY_KEY` 是敏感信息，请妥善保管，不要分享给他人或在公开场合泄露。

