# 支付签名问题深度分析报告

## 📊 当前状态分析

根据您提供的 Cloudflare Workers 日志：

### ✅ 正常的部分

1. **环境变量读取正常**
   ```json
   {
     "key_exists": true,
     "key_type": "string",
     "key_length": 32,
     "key_preview": "MDZp0p...WnFm",
     "contains_placeholder": false
   }
   ```
   - ✅ KEY 存在且长度为 32（合理）
   - ✅ KEY 预览显示为真实密钥（MDZp...开头）
   - ✅ 不包含占位符

2. **路由和参数传递正常**
   - ✅ 路由正确：`payment/create`
   - ✅ 方法正确：`POST`
   - ✅ 参数完整：money, name, out_trade_no, pid, type 都有

3. **API 响应正常**
   - ✅ 响应状态：200
   - ✅ 没有抛出异常

### ❓ 可能的问题点

虽然日志显示一切正常，但您之前收到的错误信息显示：

```
MD5签名错误，请检查签名字符串：...&type=alipay商户KEY
```

这表示签名字符串末尾是 `商户KEY`，而不是真实的密钥值。

## 🔍 可能的原因

### 1. **环境变量缓存问题**（最可能）

即使 Dashboard 中显示的环境变量是正确的，Worker 可能还在使用旧的值（从之前的部署）。

**解决方案**：强制重新部署 Worker

### 2. **签名生成时 KEY 被覆盖**

虽然日志显示 KEY 正确，但在签名生成时可能被错误地覆盖或修改。

**已添加**：详细的签名生成日志，记录：
- `buildSignPayload` 构建的签名字符串
- `md5Sign` 接收到的 KEY 值
- 最终的签名结果

### 3. **易支付服务器验证问题**

易支付服务器可能使用了不同的验证逻辑，或者参数顺序/格式不匹配。

## 🛠️ 已实施的改进

### 1. 增强的诊断日志

在 `functions/utils/zpay.js` 中添加了：

- **`buildSignPayload` 函数**：
  - 记录过滤后的参数数量和键名
  - 记录排序后的参数键顺序
  - 记录构建的签名字符串预览和长度
  - 记录签名字符串的末尾部分（用于检查是否包含占位符）

- **`md5Sign` 函数**：
  - 记录输入参数详情
  - 记录 KEY 的长度和预览
  - 检查 KEY 是否以占位符结尾
  - 记录最终的签名字符串预览
  - 记录生成的签名结果

### 2. 参数构建日志

在 `functions/api/[[path]].js` 中添加了：

- 记录构建的签名参数详情
- 记录参数的数量和键名
- 记录每个参数的值（截断敏感信息）

## 📋 下一步排查步骤

### 步骤 1：重新部署并查看详细日志

```powershell
npm run build
git add .
git commit -m "添加签名生成详细诊断日志"
git push
```

### 步骤 2：测试支付并查看日志

部署完成后，尝试支付，然后在 Cloudflare Dashboard → Logs 中查看：

1. **`构建签名字符串:`** 日志
   - 检查 `payload_ends_with` - 应该不包含 `商户KEY`
   - 检查 `sorted_keys` - 确认参数顺序正确

2. **`=== 签名生成详情 ===`** 日志
   - 检查 `key_preview` - 应该显示真实密钥（如 `MDZp0p...WnFm`）
   - 检查 `key_ends_with_placeholder` - 应该是 `false`
   - 检查 `raw_preview` - 签名字符串末尾应该显示真实密钥，而不是 `商户KEY`

3. **`签名结果:`** 日志
   - 确认签名已生成

### 步骤 3：对比分析

如果日志显示：
- ✅ KEY 正确，签名字符串正确 → 可能是易支付服务器的问题
- ❌ KEY 正确，但签名字符串末尾是 `商户KEY` → 代码中有问题
- ❌ KEY 本身就是占位符 → 环境变量未正确更新或未重新部署

## 🎯 预期结果

部署更新后，日志应该显示：

```json
{
  "构建签名字符串": {
    "payload_ends_with": "...&type=alipay",
    // 不应该包含 商户KEY
  },
  "=== 签名生成详情 ===": {
    "key_preview": "MDZp0p...WnFm",
    "key_ends_with_placeholder": false,
    "raw_preview": "...&type=alipayMDZp0p00WbUsFhzLtgMLbACHIYa8WnFm"
    // 末尾应该是真实密钥，不是 商户KEY
  }
}
```

## 📝 如果问题仍然存在

请提供部署后的完整日志，特别是：
1. `构建签名字符串:` 日志
2. `=== 签名生成详情 ===` 日志
3. 易支付返回的错误信息（如果有）

这样我可以进一步定位问题所在。

