# 🚨 立即修复支付签名问题 - 操作指南

## 问题确认

错误信息明确显示：**签名字符串末尾是 `商户KEY`**

这说明：**环境变量 `ZPAY_KEY` 的值仍然是占位符，而不是真实密钥！**

---

## ✅ 立即执行的修复步骤

### 步骤 1：在 Cloudflare Dashboard 中检查并更新环境变量

1. **登录 Cloudflare Dashboard**
   - https://dash.cloudflare.com/

2. **进入项目设置**
   - Workers 和 Pages → `psychological-assessment-platform`
   - Settings → Variables

3. **检查 `ZPAY_KEY` 的值**
   - 点击 `ZPAY_KEY` 变量
   - **当前值是什么？**
     - ❌ 如果是 `商户KEY` → 需要替换
     - ❌ 如果是其他占位符文本 → 需要替换
     - ✅ 如果是类似 `MDZp0p00...` 的真实密钥 → 检查是否完全正确

4. **获取真实密钥**
   - 登录易支付后台：https://zpayz.cn
   - 商户中心 → API接口设置
   - 复制 **商户密钥 (PKEY)** 的值

5. **更新 `ZPAY_KEY`**
   - 删除当前的值（如果是占位符）
   - 粘贴从易支付后台复制的真实密钥
   - **确保完全一致**（包括大小写、所有字符）
   - 保存

### 步骤 2：同时检查其他环境变量

- **`ZPAY_PID`**：应该是 `2025120114591699`
- **`PUBLIC_BASE_URL`**：应该是 `https://mindcube.top`（不是支付网关地址）

### 步骤 3：必须重新部署 Worker ⚠️

**这是最关键的一步！**

环境变量修改后，**必须重新部署 Worker 才能生效**。

#### 方法 A：推送代码触发自动部署

```powershell
# 在项目目录运行
npm run build
git add .
git commit -m "修复支付签名问题，添加详细诊断日志"
git push
```

#### 方法 B：手动触发部署

1. 在 Cloudflare Dashboard → **Deployments** 标签
2. 找到最新的部署
3. 点击 **Retry deployment**（重新部署）或 **Retry**
4. 等待部署完成（1-3 分钟）

### 步骤 4：验证修复

部署完成后：

1. **查看 Cloudflare Workers 日志**
   - 进入项目 → **Logs**
   - 尝试支付
   - 查看日志中的：
     - `=== 支付配置深度诊断 ===`
     - `环境变量信息:`
     - `KEY 验证详情:`

2. **检查日志输出**
   - `key_first_10_chars` - 应该显示真实密钥的前10位（如 `MDZp0p00Wb`）
   - `is_placeholder` - 应该是 `false`
   - `detected_placeholder` - 应该是 `null`

3. **测试支付**
   - 如果日志显示 KEY 正确 → 支付应该能正常工作
   - 如果仍然报错 → 查看日志中的具体错误信息

---

## 🔍 如果部署后仍然显示 `商户KEY`

### 可能的原因和解决方案

#### 原因 1：环境变量修改未保存
- **解决**：确保点击了"保存"按钮

#### 原因 2：修改了错误的环境
- **解决**：确认是在 **Production** 环境中修改

#### 原因 3：Worker 使用了缓存
- **解决**：清除缓存，或等待几分钟后重试

#### 原因 4：环境变量值确实还是占位符
- **解决**：
  1. 删除 `ZPAY_KEY` 变量
  2. 重新添加，粘贴真实密钥
  3. 保存并重新部署

---

## 📋 快速检查清单

在继续之前，请确认：

- [ ] 已在 Cloudflare Dashboard 检查 `ZPAY_KEY` 的值
- [ ] `ZPAY_KEY` 的值不是 `商户KEY` 等占位符
- [ ] `ZPAY_KEY` 的值与易支付后台完全一致
- [ ] 已保存环境变量
- [ ] 已重新部署 Worker（最重要！）
- [ ] 部署已完成
- [ ] 已查看 Cloudflare Workers 日志

---

## 🎯 下一步

1. **立即检查并更新环境变量**
2. **重新部署 Worker**
3. **查看日志确认修复**
4. **测试支付功能**

部署更新后的代码（包含详细诊断日志），然后查看 Cloudflare Workers 日志，告诉我日志中显示的 `KEY 验证详情` 的内容，我可以进一步帮助您！

