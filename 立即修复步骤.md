# 🚨 Cloudflare Pages 部署问题 - 立即修复步骤

## 问题：网站部署后无法打开（ERR_CONNECTION_CLOSED）

## ✅ 已完成的修复

我已经为你创建了 Cloudflare Pages 中间件来处理 SPA 路由问题：

1. ✅ 创建了 `functions/_middleware.js` - Cloudflare Pages 函数中间件
2. ✅ 保留了 `public/_redirects` 文件作为备用

## 🔧 现在需要做的事情

### 重要：`functions` 目录必须在项目根目录

确认你的项目结构如下：
```
项目根目录/
├── functions/
│   └── _middleware.js    ← 这个文件必须存在！
├── public/
│   └── _redirects
├── dist/                 ← 构建输出
└── ...
```

### 步骤 1：检查 functions 目录

确认 `functions/_middleware.js` 文件存在。我已经创建了这个文件。

### 步骤 2：重新构建项目（如果修改了代码）

```bash
npm run build
```

### 步骤 3：部署方式选择

#### 方式 A：使用 Git 集成（推荐）⭐

1. **确认 functions 目录已添加到 Git**
   ```bash
   git add functions/
   git commit -m "添加 Cloudflare Pages SPA 路由支持"
   git push
   ```

2. **Cloudflare Pages 会自动部署**
   - 它会自动检测到 `functions` 目录
   - 中间件会自动生效

#### 方式 B：手动上传（不推荐）

如果你直接上传 `dist` 目录，中间件不会工作，因为 `functions` 目录不在 `dist` 中。

### 步骤 4：在 Cloudflare Pages 控制台检查

1. 进入 Cloudflare Pages 控制台
2. 选择你的项目
3. 检查 **构建日志**：
   - 确认构建成功
   - 查看是否有错误信息

4. 检查 **Functions** 页面：
   - 应该能看到 `_middleware.js` 函数
   - 确认状态是 "Active"

### 步骤 5：如果仍然不行 - 手动配置路由规则

如果中间件不起作用，在 Cloudflare Pages 控制台手动配置：

1. 进入项目 **Settings**
2. 找到 **Functions & Middleware** 或 **Redirects**
3. 添加规则：
   - **Pattern**: `/*`
   - **Rewrite to**: `/index.html`
   - **Status code**: `200`

## 🐛 常见问题

### Q1: 网站完全无法访问

**检查：**
- [ ] Cloudflare Pages 构建是否成功？
- [ ] `functions/_middleware.js` 是否在项目根目录？
- [ ] 是否使用 Git 集成部署？

### Q2: 静态资源加载失败

**解决方案：**
- 中间件已经配置跳过静态资源
- 如果仍有问题，检查资源路径是否正确

### Q3: 路由返回 404

**解决方案：**
- 确认中间件已部署（在 Functions 页面查看）
- 尝试在控制台手动配置路由规则

## 📋 快速检查清单

- [ ] `functions/_middleware.js` 文件存在
- [ ] 使用 Git 集成部署（推荐）
- [ ] Cloudflare Pages 构建成功
- [ ] Functions 页面显示中间件为 Active
- [ ] 清除浏览器缓存后测试

## 🎯 下一步

1. **如果你使用 Git**：
   - 推送代码（确保包含 `functions` 目录）
   - 等待 Cloudflare Pages 自动部署

2. **如果不使用 Git**：
   - 在 Cloudflare Pages 控制台手动配置路由规则（见步骤 5）

3. **测试**：
   - 访问首页
   - 访问子路由（如 `/dashboard`）
   - 检查浏览器控制台是否有错误

---

**如果问题仍然存在，请提供：**
1. Cloudflare Pages 构建日志截图
2. 浏览器控制台错误信息
3. 访问的具体 URL

