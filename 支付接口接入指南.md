# 支付接口接入指南

## 📋 概述

本系统已集成 **易支付（ZPay）** 接口，支持支付宝等多种支付方式。本文档将指导您完成支付接口的配置和接入。

---

## 🔧 配置步骤

### 1. 获取易支付商户信息

1. **注册易支付账号**
   - 访问易支付官网：https://zpayz.cn
   - 注册商户账号并完成实名认证

2. **获取商户参数**
   - 登录易支付商户后台
   - 在"API接口"或"商户设置"中获取：
     - **商户ID（PID）**：用于标识您的商户账号
     - **商户密钥（KEY）**：用于签名验证，请妥善保管

### 2. 配置环境变量

#### 方式一：在 Cloudflare Workers 中配置（推荐）

1. 登录 [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. 选择您的 Worker 项目
3. 进入 **Settings** → **Variables**
4. 添加以下环境变量：

   ```
   ZPAY_PID = 你的商户ID
   ZPAY_KEY = 你的商户密钥
   PUBLIC_BASE_URL = https://你的域名.com
   ```

5. 点击 **Save** 保存配置

#### 方式二：在 wrangler.toml 中配置（本地开发）

在项目根目录的 `wrangler.toml` 文件中添加：

```toml
[env.production.vars]
ZPAY_PID = "你的商户ID"
ZPAY_KEY = "你的商户密钥"
PUBLIC_BASE_URL = "https://你的域名.com"

[env.development.vars]
ZPAY_PID = "测试商户ID"
ZPAY_KEY = "测试商户密钥"
PUBLIC_BASE_URL = "http://localhost:8787"
```

⚠️ **注意**：请勿将包含密钥的 `wrangler.toml` 提交到公开仓库！

#### 方式三：使用 .dev.vars 文件（本地开发，推荐）

在项目根目录创建 `.dev.vars` 文件（此文件已在 `.gitignore` 中）：

```env
ZPAY_PID=你的商户ID
ZPAY_KEY=你的商户密钥
PUBLIC_BASE_URL=http://localhost:8787
```

---

## 🔄 支付流程说明

### 支付流程图

```
用户点击支付
    ↓
前端调用 /api/payment/create
    ↓
后端生成签名并返回支付链接
    ↓
用户跳转到易支付收银台
    ↓
用户完成支付
    ↓
易支付回调 /api/payment/notify（异步通知）
    ↓
用户跳转到 return_url（同步返回）
    ↓
前端轮询订单状态
    ↓
订单状态更新为 paid，生成测试链接
    ↓
跳转到测试页面
```

### API 接口说明

#### 1. 创建支付订单

**接口**: `POST /api/payment/create`

**请求参数**:
```json
{
  "name": "问卷名称",
  "money": "10.00",
  "out_trade_no": "订单号",
  "notify_url": "https://你的域名.com/api/payment/notify",
  "return_url": "https://你的域名.com/payment?result=return&order=订单号",
  "type": "alipay",
  "param": "questionnaire_type"
}
```

**返回数据**:
```json
{
  "code": 0,
  "data": {
    "payUrl": "https://zpayz.cn/submit.php?..."
  }
}
```

#### 2. 支付异步通知回调

**接口**: `GET /api/payment/notify`

**说明**:
- 此接口由易支付服务器主动调用
- 系统会自动验证签名并更新订单状态
- 支付成功后会生成测试链接并关联到订单

**回调参数**:
```
trade_status=TRADE_SUCCESS
out_trade_no=商户订单号
trade_no=易支付交易号
sign=签名
sign_type=MD5
```

#### 3. 查询订单状态

**接口**: `GET /api/payment/order-status?out_trade_no=订单号`

**返回数据**:
```json
{
  "code": 0,
  "data": {
    "outTradeNo": "订单号",
    "status": "paid",
    "questionnaireType": "问卷类型",
    "linkId": "测试链接ID"
  }
}
```

**订单状态说明**:
- `pending`: 待支付
- `paid`: 已支付
- `cancelled`: 已取消
- `failed`: 支付失败

---

## 🌐 支付方式配置

### 支持的支付类型

目前系统支持以下支付方式（通过 `type` 参数指定）：

| 类型 | type 值 | 说明 |
|------|---------|------|
| 支付宝 | `alipay` | 支付宝扫码/跳转支付 |
| 微信支付 | `wxpay` | 微信扫码支付 |
| QQ钱包 | `qqpay` | QQ钱包支付 |
| 网银 | `bank` | 网银支付 |

**修改支付方式**:

在 `src/pages/Payment.tsx` 中修改：

```typescript
const [paymentMethod] = useState<'alipay' | 'wxpay' | 'qqpay' | 'bank'>('alipay')
```

---

## 🧪 测试支付功能

### 1. 使用易支付测试环境

易支付通常提供测试环境，您可以使用测试商户ID和密钥进行测试。

### 2. 测试步骤

1. **配置测试环境变量**
   ```env
   ZPAY_PID=测试商户ID
   ZPAY_KEY=测试商户密钥
   ```

2. **启动本地开发服务器**
   ```bash
   npm run dev
   ```

3. **访问支付页面**
   ```
   http://localhost:8787/payment?type=问卷类型
   ```

4. **测试支付流程**
   - 点击"立即支付"按钮
   - 检查是否正常跳转到易支付收银台
   - 使用测试账号完成支付
   - 验证是否正常回调并生成测试链接

### 3. 查看支付日志

在 Cloudflare Workers 的控制台中可以查看：
- 支付订单创建日志
- 回调通知日志
- 错误信息

---

## 🔒 安全注意事项

1. **密钥安全**
   - ⚠️ 绝对不要将 `ZPAY_KEY` 提交到代码仓库
   - ⚠️ 使用环境变量存储密钥，不要硬编码
   - ⚠️ 定期更换密钥

2. **签名验证**
   - 系统已自动实现签名验证
   - 所有回调请求都会验证签名，确保安全

3. **HTTPS**
   - 生产环境必须使用 HTTPS
   - `notify_url` 和 `return_url` 必须是 HTTPS 地址

4. **订单号唯一性**
   - `out_trade_no`（商户订单号）必须唯一
   - 建议使用 UUID 或时间戳+随机数生成

---

## 🐛 常见问题

### Q1: 支付失败，提示"支付配置未完成"

**原因**: 环境变量未正确配置

**解决**:
1. 检查 `ZPAY_PID` 和 `ZPAY_KEY` 是否正确设置
2. 在 Cloudflare Dashboard 中确认环境变量已保存
3. 重新部署 Worker

### Q2: 支付成功但没有收到回调通知

**原因**: 
- `notify_url` 无法访问（可能被防火墙拦截）
- 易支付服务器无法访问您的回调地址

**解决**:
1. 确认 `notify_url` 是公网可访问的 HTTPS 地址
2. 检查服务器防火墙设置
3. 在易支付商户后台查看回调日志

### Q3: 回调验证签名失败

**原因**: 
- 密钥配置错误
- 签名算法不匹配

**解决**:
1. 确认 `ZPAY_KEY` 与易支付后台的密钥完全一致（注意空格）
2. 检查签名算法是否为 MD5
3. 查看易支付文档确认签名规则

### Q4: 如何修改支付网关地址

当前使用的支付网关：`https://zpayz.cn/submit.php`

如需修改，编辑 `functions/api/[[path]].js` 第 241 行：

```javascript
const url = new URL('https://你的支付网关地址/submit.php')
```

### Q5: 如何支持其他支付平台

如需集成其他支付平台（如支付宝官方、微信支付等），需要：

1. 创建新的支付工具文件（参考 `functions/utils/zpay.js`）
2. 实现该平台的签名和验证逻辑
3. 在 `handlePaymentRoutes` 中添加对应的处理逻辑
4. 修改前端 `Payment.tsx` 中的支付方式选项

---

## 📚 相关文件

- **后端支付路由**: `functions/api/[[path]].js` (第 194-317 行)
- **支付工具函数**: `functions/utils/zpay.js`
- **前端支付页面**: `src/pages/Payment.tsx`
- **订单数据模型**: `functions/utils/db.js` (OrderDB 类)

---

## 📞 技术支持

- 易支付官方文档: https://zpayz.cn/docs
- 易支付客服: 登录商户后台查看联系方式
- 系统问题: 查看项目 Issue 或联系开发者

---

## ✅ 配置检查清单

在正式上线前，请确认：

- [ ] 已获取易支付商户ID和密钥
- [ ] 已在 Cloudflare Workers 中配置环境变量
- [ ] `PUBLIC_BASE_URL` 设置为正确的生产域名
- [ ] `notify_url` 使用 HTTPS 地址
- [ ] 已测试支付流程（创建订单 → 支付 → 回调 → 生成链接）
- [ ] 已测试订单状态查询功能
- [ ] 已查看支付日志，确认无错误
- [ ] 已设置密钥安全保护措施

---

**最后更新**: 2024年12月

