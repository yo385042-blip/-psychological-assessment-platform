# 🚨 立即修复 ZPAY_KEY 占位符问题

## 问题诊断

错误信息显示：签名字符串末尾是 `&type=alipay商户KEY`

这说明 `ZPAY_KEY` 环境变量的值仍然是占位符 **"商户KEY"**，而不是真实的易支付密钥。

## 立即修复步骤

### 步骤 1：登录 Cloudflare Dashboard

访问：https://dash.cloudflare.com/
- 登录您的账号

### 步骤 2：进入项目设置

1. 点击左侧菜单 **"Workers & Pages"**
2. 找到您的项目（psychological-assessment-platform 或您的项目名称）
3. 点击项目名称进入项目详情

### 步骤 3：检查并修复环境变量

1. 点击顶部菜单 **"Settings"**（设置）
2. 左侧菜单选择 **"Variables"**（变量）
3. 找到 **ZPAY_KEY** 变量
4. 检查当前值：
   - ❌ 如果值是 "商户KEY" 或类似占位符 → **需要修改**
   - ❌ 如果值长度很短（少于20位）→ **需要修改**
   - ✅ 如果值是32位字母数字组合 → **正确**

### 步骤 4：获取真实密钥

1. 登录易支付后台：https://zpayz.cn
2. 进入 **商户管理** 或 **API设置** 页面
3. 找到 **商户密钥** 或 **API密钥**
4. 复制完整的密钥（通常是32位字母数字组合，例如：`a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6`）

### 步骤 5：更新环境变量

1. 在 Cloudflare Dashboard 的 Variables 页面
2. 点击 **ZPAY_KEY** 右侧的编辑按钮
3. **删除**旧的占位符值
4. **粘贴**从易支付后台复制的真实密钥
5. 确认密钥值：
   - ✅ 长度通常是32位
   - ✅ 只包含字母和数字
   - ✅ 不包含 "商户KEY"、"你的" 等文字
6. 点击 **保存**

### 步骤 6：重新部署（⚠️ 必须）

环境变量修改后**必须重新部署**才能生效！

#### 方法 1：在 Dashboard 重新部署（推荐）
1. 在项目页面，点击 **"Deployments"**（部署）标签
2. 找到最新的部署记录
3. 点击部署右侧的 **"..."** 菜单
4. 选择 **"Retry deployment"**（重新部署）
5. 等待部署完成（通常1-2分钟）

#### 方法 2：推送代码触发自动部署
```powershell
cd "C:\Users\26872\Desktop\心理网站编写\02 管理器"
git add .
git commit -m "更新环境变量配置"
git push
```

### 步骤 7：验证修复

1. 等待部署完成（查看 Deployments 页面状态变为 "Success"）
2. 访问购买套餐页面
3. 点击 "立即购买"
4. 应该能正常跳转到支付页面，不再出现签名错误

## 验证清单

- [ ] 已登录 Cloudflare Dashboard
- [ ] 已找到项目并进入 Settings → Variables
- [ ] 已检查 ZPAY_KEY 的当前值
- [ ] 已从易支付后台复制真实密钥
- [ ] 已更新 ZPAY_KEY 环境变量的值
- [ ] 已确认密钥值不包含 "商户KEY" 等占位符
- [ ] 已保存环境变量
- [ ] **已重新部署 Worker（最重要！）**
- [ ] 已测试支付功能正常工作

## 常见问题

### Q: 我找不到易支付后台的密钥？
**A:** 
- 登录 https://zpayz.cn
- 查看 **商户信息** 或 **API配置** 页面
- 密钥字段可能叫做：**商户密钥**、**API密钥**、**支付密钥**、**签名密钥**

### Q: 密钥值应该是什么样的？
**A:** 
- ✅ 正确：32位字母数字组合，例如 `a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6`
- ❌ 错误：`商户KEY`、`你的密钥`、`请填写` 等占位符

### Q: 我已经更新了环境变量，但还是报错？
**A:** 
- **必须重新部署才能生效！**
- 检查是否在正确的环境（Production/Preview）配置了变量
- 检查变量名称拼写是否正确：`ZPAY_KEY`（全部大写）

### Q: 如何确认环境变量已生效？
**A:**
- 查看 Cloudflare Dashboard → Deployments → 最新部署的日志
- 搜索 "支付配置深度诊断" 日志
- 查看 `key_preview` 是否显示真实密钥的前6位和后4位

## 需要帮助？

如果按照以上步骤操作后仍有问题，请：
1. 检查 Cloudflare Dashboard → Deployments → 最新部署的日志
2. 查找包含 "支付配置" 或 "ZPAY_KEY" 的日志
3. 查看错误详情并截图

