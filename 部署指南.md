# 部署指南

## 部署到 Cloudflare Pages

### 前置要求
1. 已安装 Node.js 和 npm
2. 已安装 Cloudflare Wrangler CLI（可选，用于本地测试）
3. 已连接到 GitHub 仓库

### 部署步骤

#### 方法1：通过 GitHub 自动部署（推荐）

1. **准备代码**
   - 确保所有代码已提交到 GitHub
   - 确保 `functions/` 目录在项目根目录
   - 确保 `wrangler.toml` 配置文件存在

2. **在 Cloudflare Dashboard 中配置**
   - 登录 Cloudflare Dashboard
   - 进入 Pages 页面
   - 点击 "Create a project"
   - 选择 "Connect to Git"
   - 选择你的 GitHub 仓库
   - 配置构建设置：
     - **Build command**: `npm run build`
     - **Build output directory**: `dist`
     - **Root directory**: `/` (项目根目录)
     - **Node version**: `18` 或更高

3. **环境变量配置**（如果需要）
   - 在 Cloudflare Pages 项目设置中添加环境变量
   - 例如：`JWT_SECRET`、`DB` (KV绑定名称)

4. **KV 绑定配置**
   - 在 Cloudflare Dashboard 中创建 KV Namespace
   - 在 Pages 项目设置中绑定 KV Namespace
   - 绑定名称应与 `wrangler.toml` 中的配置一致

5. **部署**
   - 每次推送到 GitHub 主分支会自动触发部署
   - 或手动点击 "Retry deployment"

#### 方法2：使用 Wrangler CLI 部署

1. **安装 Wrangler**
   ```bash
   npm install -g wrangler
   ```

2. **登录 Cloudflare**
   ```bash
   wrangler login
   ```

3. **构建项目**
   ```bash
   npm run build
   ```

4. **部署**
   ```bash
   wrangler pages deploy dist
   ```

### 构建命令说明

项目使用以下构建命令：
```bash
npm run build
```

这会执行：
1. `tsc` - TypeScript 类型检查
2. `vite build` - 构建前端资源
3. `npm run copy-functions` - 复制 functions 目录到 dist

### 项目结构要求

部署时，确保以下结构：
```
项目根目录/
├── functions/          # Cloudflare Functions（必须）
│   ├── _middleware.js
│   ├── api/
│   └── utils/
├── dist/              # 构建输出（自动生成）
│   ├── functions/     # 从 functions/ 复制而来
│   ├── assets/
│   └── index.html
├── wrangler.toml      # Cloudflare 配置
└── package.json
```

### 验证部署

部署成功后，访问你的 Cloudflare Pages URL，检查：
1. 首页是否正常加载
2. API 路由是否正常工作（如 `/api/auth/login`）
3. 静态资源是否正常加载

### 常见问题

1. **构建失败**
   - 检查 Node.js 版本（建议 18+）
   - 检查依赖是否安装完整：`npm install`
   - 检查 TypeScript 编译错误

2. **Functions 不工作**
   - 确保 `functions/` 目录在项目根目录
   - 确保 `dist/functions/` 目录存在
   - 检查 `wrangler.toml` 配置

3. **KV 绑定失败**
   - 确保在 Cloudflare Dashboard 中创建了 KV Namespace
   - 确保绑定名称与代码中的一致
   - 检查环境变量配置

### 更新部署

每次更新代码后：
1. 提交代码到 GitHub
2. Cloudflare Pages 会自动检测并重新部署
3. 或手动触发部署

### 回滚部署

如果需要回滚到之前的版本：
1. 在 Cloudflare Pages Dashboard 中
2. 进入 "Deployments" 页面
3. 找到之前的部署版本
4. 点击 "Retry deployment" 或 "Promote to production"


