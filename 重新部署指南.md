# 🚀 重新部署指南

## 📋 部署步骤

### 方式一：通过 Git 推送自动部署（推荐）

如果您已经连接了 GitHub 仓库，Cloudflare Pages 会自动部署。

#### 1. 构建项目

在项目目录打开 PowerShell 或终端，运行：

```powershell
npm run build
```

这会：
- 编译 TypeScript
- 构建前端代码
- 复制 `functions/` 目录到 `dist/functions/`

#### 2. 提交更改到 Git

```powershell
# 查看更改的文件
git status

# 添加所有更改的文件
git add .

# 提交更改（包含我们修复的支付和认证路由）
git commit -m "修复: 添加支付接口调试日志和修复 /api/auth/me 路由"

# 推送到远程仓库
git push
```

#### 3. 等待自动部署

推送后，Cloudflare Pages 会自动检测到更改并开始部署：

1. **登录 Cloudflare Dashboard**
   - 访问：https://dash.cloudflare.com/
   - 进入：**Workers 和 Pages** → **psychological-assessment-platform**

2. **查看部署状态**
   - 点击 **部署**（Deployments）标签
   - 应该能看到新的部署正在进行中
   - 等待部署完成（显示绿色成功图标）

#### 4. 验证部署

部署完成后，测试：

1. **访问网站**：
   ```
   https://mindcube.top
   ```

2. **测试 API**：
   - 打开浏览器开发者工具（F12）
   - 尝试登录或支付
   - 查看是否还有错误

---

### 方式二：通过 Cloudflare Dashboard 手动上传

如果 Git 自动部署不可用：

#### 1. 构建项目

```powershell
npm run build
```

#### 2. 在 Cloudflare Dashboard 中上传

1. 登录 Cloudflare Dashboard
2. 进入项目页面
3. 点击 **上传资产** 或 **Upload assets**
4. 选择 `dist` 目录下的所有文件上传
5. 等待部署完成

---

### 方式三：使用 Wrangler CLI 部署

如果已安装 Wrangler CLI：

```powershell
# 安装 Wrangler（如果还没有）
npm install -g wrangler

# 构建项目
npm run build

# 部署到 Cloudflare Pages
wrangler pages deploy dist --project-name=psychological-assessment-platform
```

---

## ✅ 本次部署包含的修复

### 1. 支付接口修复
- ✅ 添加了详细的调试日志
- ✅ 修复了路由解析问题
- ✅ 改进了错误处理

### 2. 认证路由修复
- ✅ 修复了 `/api/auth/me` 404 错误
- ✅ 支持未登录状态访问
- ✅ 改进了 token 验证逻辑

### 3. HTML 导入功能
- ✅ 添加了 HTML 文件解析支持
- ✅ 可以从 HTML 网页中提取题目

---

## 🔍 部署后验证清单

部署完成后，请测试以下功能：

### 基础功能
- [ ] 网站可以正常访问
- [ ] 登录功能正常
- [ ] 注册功能正常
- [ ] `/api/auth/me` 不再返回 404

### 支付功能
- [ ] 支付页面可以正常加载
- [ ] 点击支付按钮不再出现"支付网关返回异常"
- [ ] 可以正常跳转到支付收银台

### 其他功能
- [ ] 题目导入功能正常
- [ ] HTML 文件可以导入

---

## 🐛 如果部署失败

### 1. 检查构建日志

在 Cloudflare Dashboard → 部署 → 查看构建日志：
- 是否有错误信息？
- Functions 文件是否被复制？
- 构建是否成功完成？

### 2. 检查环境变量

确认已配置：
- `ZPAY_PID` - 易支付商户ID
- `ZPAY_KEY` - 易支付商户密钥
- `PUBLIC_BASE_URL` - 网站地址（如：https://mindcube.top）

### 3. 检查 KV 绑定

在 Settings → Bindings：
- 确认 KV 命名空间 "DB" 已绑定

### 4. 重新触发部署

- 点击最新的部署
- 点击 **重新部署**（Retry deployment）

---

## 📞 需要帮助？

如果遇到问题：

1. **查看 Cloudflare Workers 日志**
   - 在 Dashboard → Logs 中查看错误信息
   - 查找我们添加的调试日志

2. **检查浏览器控制台**
   - 按 F12 打开开发者工具
   - 查看 Console 和 Network 标签

3. **提供错误信息**
   - 截图或复制错误信息
   - 告诉我具体的错误内容

---

## 🎯 快速命令总结

```powershell
# 1. 构建
npm run build

# 2. 查看更改
git status

# 3. 提交（如果使用 Git）
git add .
git commit -m "修复: 支付和认证路由问题"
git push

# 4. 等待 Cloudflare 自动部署（3-5分钟）

# 5. 测试网站
# 访问 https://mindcube.top
```

---

**最后更新**: 2024年12月

