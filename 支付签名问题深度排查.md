# 支付签名问题深度排查

## 🔴 当前问题

签名字符串末尾仍然是 `商户KEY`，说明环境变量 `ZPAY_KEY` 的值仍然是占位符。

## 📊 问题分析

### 可能原因

1. **环境变量未重新部署**（最可能）
   - 修改环境变量后，必须重新部署 Worker 才能生效
   - 代码仍在运行旧的环境变量值

2. **环境变量类型问题**
   - 如果 `ZPAY_KEY` 设置为 "密钥" (Secret) 类型，读取方式应该是正确的
   - 但需要确认代码是否正确读取 Secret 类型的环境变量

3. **环境变量作用域问题**
   - 可能修改的是 Development 环境，但运行的是 Production
   - 或者相反

4. **环境变量值本身的问题**
   - 虽然界面显示正确，但实际存储的值可能不对
   - 可能有隐藏字符或编码问题

## 🔍 深度排查步骤

### 步骤1：验证环境变量已正确保存

在 Cloudflare Dashboard 中：

1. 进入项目 → **Settings** → **Variables**
2. 检查 `ZPAY_KEY` 的值：
   - ✅ 应该是：`MDZp0p00WbUsFhzLtgMLbACHIYa8WnFm`
   - ❌ 不应该包含：`商户KEY`、`你的` 等占位符文本
3. 检查 `ZPAY_KEY` 的类型：
   - 应该是 **"密钥" (Secret)** 类型
4. 检查是否在正确的环境：
   - 如果是 Pages 项目，确认是在 **Production** 环境修改

### 步骤2：检查部署状态

1. 进入 **Deployments** 标签
2. 查看最新的部署：
   - 部署时间是什么时候？
   - 是否在修改环境变量之后？
   - 部署状态是否成功？

### 步骤3：查看 Cloudflare Workers 日志

1. 进入 **Logs** 标签
2. 尝试支付，查看日志输出
3. 查找以下日志：
   ```
   支付配置检查: { ... }
   KEY 验证: { ... }
   ```
4. 检查日志中显示的实际 KEY 值：
   - `key_preview` - 显示 KEY 的前后几位
   - `key_length` - KEY 的长度
   - `key_contains_placeholder` - 是否包含占位符

### 步骤4：验证环境变量读取

部署更新后的代码（包含详细日志），然后：

1. 尝试支付
2. 查看 Cloudflare Workers 日志
3. 检查日志中的：
   - `env_keys` - 显示所有可用的环境变量键
   - `key_preview` - 实际读取到的 KEY 值预览
   - `key_contains_placeholder` - 是否为占位符

## 🛠️ 解决方案

### 方案1：确保重新部署（最重要）

```powershell
# 1. 提交代码更改
git add .
git commit -m "添加支付环境变量诊断日志"
git push

# 2. 等待 Cloudflare 自动部署（3-5分钟）

# 3. 或者在 Dashboard 中手动触发部署
```

### 方案2：检查环境变量值

如果环境变量的值确实是占位符：

1. 登录易支付后台：https://zpayz.cn
2. 复制真实的商户密钥
3. 在 Cloudflare Dashboard 中：
   - 删除旧的 `ZPAY_KEY` 变量
   - 重新添加 `ZPAY_KEY` 变量
   - 粘贴真实的密钥值
   - 保存
4. **重新部署 Worker**

### 方案3：使用 Wrangler CLI 验证

如果安装了 Wrangler CLI：

```powershell
# 查看环境变量（不显示值，只显示键）
wrangler pages secret list --project-name=psychological-assessment-platform
```

## 📋 验证清单

- [ ] `ZPAY_KEY` 环境变量已设置为真实密钥值（不是占位符）
- [ ] `ZPAY_KEY` 的值与易支付后台完全一致
- [ ] `ZPAY_KEY` 保存为 "密钥" (Secret) 类型
- [ ] 环境变量在 Production 环境中修改
- [ ] 环境变量修改后已重新部署 Worker
- [ ] 最新部署的时间在环境变量修改之后
- [ ] Cloudflare Workers 日志显示正确的 KEY 值

## 🔬 诊断代码

代码中已添加的诊断日志会显示：

```javascript
支付配置检查: {
  env_keys: "...",           // 可用的环境变量键
  pid_exists: true/false,    // PID 是否存在
  key_exists: true/false,    // KEY 是否存在
  key_length: 数字,          // KEY 的长度
  key_preview: "...",        // KEY 的前后几位
  key_contains_placeholder: true/false  // 是否包含占位符
}
```

## 🎯 下一步行动

1. **立即重新部署 Worker**
   - 这是最关键的一步
   - 环境变量修改后必须重新部署才能生效

2. **查看部署后的日志**
   - 确认实际读取到的 KEY 值
   - 验证是否不再是占位符

3. **如果日志显示仍然是占位符**
   - 重新检查 Cloudflare Dashboard 中的值
   - 可能需要删除并重新添加环境变量

---

**最重要：请先重新部署 Worker，然后查看日志！**

