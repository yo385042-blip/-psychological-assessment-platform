# 路由错误排查：认证路由不存在

## 问题现象

请求 `/api/payment/create` 时收到错误：
```json
{"success":false,"message":"认证路由不存在","code":404}
```

## 问题分析

这个错误表明请求被错误地路由到了 `handleAuthRoutes` 而不是 `handlePaymentRoutes`。

## 可能的原因

### 1. 路径解析错误
请求路径 `/api/payment/create` 应该被解析为：
- `pathSegments = ['payment', 'create']`
- `resource = 'payment'`
- `action = 'create'`

但如果路径解析错误，可能导致 `resource` 不是 `'payment'`。

### 2. Cloudflare Pages Functions 路由配置问题
`functions/api/[[path]].js` 应该捕获 `/api/*` 路径，`[[path]]` 应该是剩余路径。

## 排查步骤

### 步骤1：查看 Cloudflare Workers 日志

1. 登录 Cloudflare Dashboard
2. 进入您的 Worker → **Logs**
3. 尝试支付，查看日志输出：
   - `路径解析:` - 显示原始 path 参数
   - `路径分段:` - 显示 pathSegments 数组
   - `路由调试:` - 显示 resource 和 action

### 步骤2：检查路径格式

确认前端请求的路径是正确的：
```javascript
// 应该使用相对路径或完整路径
fetch('/api/payment/create', { ... })
// 或
fetch('https://您的域名.com/api/payment/create', { ... })
```

### 步骤3：验证文件结构

确认文件结构正确：
```
functions/
  api/
    [[path]].js    ← 这个文件应该存在
```

### 步骤4：检查中间件

`functions/_middleware.js` 应该让 `/api/*` 路径直接通过：
```javascript
if (pathname.startsWith('/api/')) {
  return next()
}
```

## 临时解决方案

如果问题持续，可以尝试：

### 方案1：使用完整的 API 路径

修改前端代码，使用完整路径：
```typescript
const resp = await fetch(`${window.location.origin}/api/payment/create`, {
  // ...
})
```

### 方案2：检查 Cloudflare 部署配置

确认 Cloudflare Pages Functions 已正确部署：
- 检查 `functions` 目录是否在部署中包含
- 确认 `[[path]].js` 文件格式正确

### 方案3：查看实际请求

在浏览器开发者工具中：
1. 打开 Network 标签
2. 尝试支付
3. 查看实际发送的请求 URL
4. 检查响应内容

## 调试日志说明

现在代码中已添加了详细的调试日志：

1. **路径解析日志**：
   ```
   路径解析: { path: '...', rawPath: '...', url: '...' }
   路径分段: ['payment', 'create']
   ```

2. **路由调试日志**：
   ```
   路由调试: {
     pathSegments: ['payment', 'create'],
     resource: 'payment',
     action: 'create',
     method: 'POST',
     url: 'https://...'
   }
   ```

3. **路由处理日志**：
   ```
   进入支付路由处理: { action: 'create', method: 'POST' }
   ```

如果看到这些日志，可以确定问题出在哪里。

## 下一步

1. 部署更新后的代码（包含调试日志）
2. 尝试支付并查看 Cloudflare Workers 日志
3. 将日志信息发给我，我可以进一步诊断

## 快速检查清单

- [ ] 已部署包含调试日志的代码
- [ ] 已查看 Cloudflare Workers 日志
- [ ] 已确认请求路径格式正确
- [ ] 已检查 `functions/api/[[path]].js` 文件存在
- [ ] 已确认 `functions/_middleware.js` 正确处理 `/api/*` 路径

