# 支付网关返回异常 - 排查指南

## 🔍 错误说明

"支付网关返回异常" 表示在创建支付订单时，后端返回的数据格式不符合预期。

---

## 📋 排查步骤

### 1. 检查环境变量配置

**问题**：最常见的原因是环境变量未正确配置。

**解决方法**：
1. 登录 Cloudflare Dashboard
2. 进入您的 Worker → Settings → Variables
3. 确认已添加以下变量：
   - `ZPAY_PID` - 易支付商户ID
   - `ZPAY_KEY` - 易支付商户密钥
   - `PUBLIC_BASE_URL` - 您的网站地址（如：https://psytest.store）

4. **验证方法**：
   - 在浏览器中打开开发者工具（F12）
   - 切换到 Console（控制台）标签
   - 尝试支付，查看控制台输出的日志
   - 如果看到 "支付配置错误: ZPAY_PID 或 ZPAY_KEY 未配置"，说明环境变量未生效

### 2. 确认环境变量已生效

**问题**：配置了环境变量但未生效。

**解决方法**：
1. 检查是否保存了环境变量
2. 确认变量名称拼写正确（区分大小写）
3. **重要**：环境变量修改后需要重新部署才能生效
   - 如果启用了自动部署，推送代码后会自动部署
   - 或手动在 Cloudflare Dashboard 中触发一次部署

### 3. 检查易支付商户信息

**问题**：商户ID或密钥错误。

**验证步骤**：
1. 登录易支付商户后台：https://zpayz.cn
2. 确认商户ID（PID）和密钥（KEY）是否正确
3. 确认账号状态是否正常（未冻结、未过期）
4. 检查账号是否有余额或额度限制

### 4. 查看详细错误日志

**方法**：

1. **浏览器控制台**：
   - 按 F12 打开开发者工具
   - 切换到 Console（控制台）
   - 尝试支付，查看红色错误信息
   - 查看 "支付接口返回:" 的日志内容

2. **Cloudflare Workers 日志**：
   - 登录 Cloudflare Dashboard
   - 进入您的 Worker → Logs
   - 查看最近的错误日志
   - 查找包含 "支付配置错误" 或 "支付接口" 的日志

### 5. 测试 API 接口

**使用 curl 或 Postman 测试**：

```bash
curl -X POST https://你的域名.com/api/payment/create \
  -H "Content-Type: application/json" \
  -d '{
    "name": "测试问卷",
    "money": "1.00",
    "out_trade_no": "test-' + Date.now() + '",
    "notify_url": "https://你的域名.com/api/payment/notify",
    "return_url": "https://你的域名.com/payment?result=return&order=test",
    "type": "alipay",
    "param": "test"
  }'
```

**预期的正常响应**：
```json
{
  "code": 0,
  "message": "",
  "data": {
    "payUrl": "https://zpayz.cn/submit.php?..."
  }
}
```

**如果返回错误**：
- `code: 500, message: "支付配置未完成..."` → 环境变量未配置
- `code: 400, message: "缺少必要参数"` → 请求参数不完整
- 其他错误 → 查看 message 字段了解详情

---

## 🛠️ 常见错误及解决方案

### 错误1：支付配置未完成

**错误信息**：`支付配置未完成，请在环境变量中配置 ZPAY_PID 与 ZPAY_KEY`

**原因**：
- 环境变量未配置
- 环境变量名称拼写错误
- 环境变量未生效（需要重新部署）

**解决**：
1. 检查 Cloudflare Dashboard 中的环境变量
2. 确认变量名称完全一致（区分大小写）
3. 保存后重新部署 Worker

### 错误2：缺少必要参数

**错误信息**：`缺少必要参数`

**原因**：请求参数不完整

**解决**：检查前端代码是否正确传递了所有必需参数：
- name（问卷名称）
- money（金额）
- out_trade_no（订单号）
- notify_url（回调地址）
- return_url（返回地址）

### 错误3：数据库操作失败

**错误信息**：可能是数据库连接或操作错误

**原因**：
- KV 存储未正确绑定
- 数据库操作权限问题

**解决**：
1. 检查 Cloudflare Dashboard → Settings → Bindings
2. 确认 KV 命名空间 "DB" 已绑定
3. 检查 KV 命名空间是否存在

### 错误4：签名生成失败

**错误信息**：可能没有明确提示，但支付链接无效

**原因**：
- 商户密钥错误
- 签名算法问题

**解决**：
1. 确认 ZPAY_KEY 与易支付后台完全一致
2. 注意密钥中可能包含的特殊字符
3. 不要有多余的空格或换行

---

## 🔧 调试技巧

### 1. 添加调试日志

在浏览器控制台查看详细日志：

```javascript
// 打开浏览器控制台（F12），在支付时查看：
- "支付接口返回:" 后面会显示后端返回的完整数据
- "支付接口错误:" 会显示具体错误信息
```

### 2. 检查网络请求

1. 打开浏览器开发者工具（F12）
2. 切换到 Network（网络）标签
3. 尝试支付
4. 找到 `/api/payment/create` 请求
5. 查看：
   - **Request**（请求）：检查发送的参数
   - **Response**（响应）：查看服务器返回的内容
   - **Status**（状态码）：正常应该是 200

### 3. 验证环境变量值

**注意**：不要直接输出密钥，仅用于调试

在 Cloudflare Workers 代码中临时添加日志（调试完成后删除）：

```javascript
console.log('ZPAY_PID:', pid ? '已配置' : '未配置')
console.log('ZPAY_KEY:', key ? '已配置（长度: ' + key.length + '）' : '未配置')
```

---

## ✅ 快速检查清单

在提交问题前，请确认：

- [ ] 已在 Cloudflare Dashboard 配置了 `ZPAY_PID`
- [ ] 已在 Cloudflare Dashboard 配置了 `ZPAY_KEY`
- [ ] 已在 Cloudflare Dashboard 配置了 `PUBLIC_BASE_URL`
- [ ] 环境变量保存后已重新部署 Worker
- [ ] 变量名称拼写完全正确（区分大小写）
- [ ] 易支付商户账号状态正常
- [ ] 商户ID和密钥与易支付后台完全一致
- [ ] 已查看浏览器控制台的错误日志
- [ ] 已查看 Cloudflare Workers 的日志
- [ ] 已测试 API 接口是否正常响应

---

## 📞 需要帮助？

如果以上步骤都无法解决问题，请提供以下信息：

1. **错误信息**：浏览器控制台或服务器日志中的完整错误
2. **网络请求详情**：`/api/payment/create` 的请求和响应内容
3. **环境变量配置**：确认已配置哪些变量（不要发送密钥值）
4. **易支付账号状态**：账号是否正常、是否有额度限制

---

**最后更新**: 2024年12月

